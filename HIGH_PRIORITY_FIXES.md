# ‚ö†Ô∏è –í—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

> –î–∞—Ç–∞: –Ø–Ω–≤–∞—Ä—å 2025
> –°—Ç–∞—Ç—É—Å: ‚úÖ –í—Å–µ 6 –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üìã –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ **6 –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º** (~7 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã):

1. ‚úÖ **Timezone-aware datetime** - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø–∏—Å–æ–∫
2. ‚úÖ **Hardcoded httpx timeout** - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–∞–π–º–∞—É—Ç–æ–≤
3. ‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ summarizer** - –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
4. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è image_data** - –ó–∞—â–∏—Ç–∞ –æ—Ç DoS —á–µ—Ä–µ–∑ memory exhaustion
5. ‚úÖ **Cleanup —Å—Ç–∞—Ä—ã—Ö chat_history** - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –¥–∏—Å–∫–∞
6. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è charge_id** - –ó–∞—â–∏—Ç–∞ –æ—Ç DoS –Ω–∞ –ë–î

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:** 8 —Ñ–∞–π–ª–æ–≤  
**–°–æ–∑–¥–∞–Ω–æ –º–∏–≥—Ä–∞—Ü–∏–π:** 1 –º–∏–≥—Ä–∞—Ü–∏—è Alembic  
**–ù–æ–≤—ã—Ö endpoint'–æ–≤:** 1 (cleanup)

---

## ‚úÖ –î–µ—Ç–∞–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. Timezone-aware datetime inconsistency

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–º–µ—à–∏–≤–∞–Ω–∏–µ timezone-aware –∏ naive datetime –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ incorrect comparisons –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏.

**–†–∏—Å–∫:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ ‚Üí —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏: `level_unlocked_at` –∏ `subscription_expires` –∏—Å–ø–æ–ª—å–∑—É—é—Ç `DateTime(timezone=True)`
- –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `a1b2c3d4e5f6_make_datetime_timezone_aware.py`
- –í—Å–µ datetime –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `datetime.now(timezone.utc)`

**–§–∞–π–ª—ã:**
- `server/models.py:47,49` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∏–ø—ã –∫–æ–ª–æ–Ω–æ–∫
- `alembic/versions/a1b2c3d4e5f6_make_datetime_timezone_aware.py` - –º–∏–≥—Ä–∞—Ü–∏—è

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
alembic upgrade head  # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```

---

### 2. Hardcoded httpx timeout

**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∞–∑–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö (30s vs 180s) –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

**–†–∏—Å–∫:** –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, —Å–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `config.py`:
  - `HTTPX_TIMEOUT = 180` (–æ–±—â–∏–π —Ç–∞–π–º–∞—É—Ç)
  - `HTTPX_CONNECT_TIMEOUT = 10` (—Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
- –û–±–Ω–æ–≤–ª–µ–Ω `bot.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã—Ö —Ç–∞–π–º–∞—É—Ç–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `.env.example`

**–§–∞–π–ª—ã:**
- `config.py:71-73` - –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- `bot/bot.py:13,90` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- `.env.example:21-23` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```bash
# –í .env —Ñ–∞–π–ª–µ:
HTTPX_TIMEOUT=180
HTTPX_CONNECT_TIMEOUT=10
```

---

### 3. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ summarizer

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ë–î (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏, —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π) –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –æ—Ç–¥–µ–ª—å–Ω–æ, —Ä–∏—Å–∫ data inconsistency.

**–†–∏—Å–∫:** –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö, —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º —É—Å–ø–µ—Ö–µ –æ–ø–µ—Ä–∞—Ü–∏–π.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –í—Å–µ —Ç—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–µ—Ä–Ω—É—Ç—ã –≤ –û–î–ù–£ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á–µ—Ä–µ–∑ `async with session.begin()`
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä—è–º—ã–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ ORM —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

**–§–∞–π–ª:**
- `server/summarizer.py:156-216` - –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏

**–ö–æ–¥:**
```python
async with async_session_factory() as session:
    async with session.begin():  # –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø
        # 1. Update profile
        stmt = update(UserProfile).where(...).values(...)
        await session.execute(stmt)
        
        # 2. Save summary (UPSERT)
        stmt = insert(ChatSummary).values(...).on_conflict_do_update(...)
        await session.execute(stmt)
        
        # 3. Delete processed messages
        stmt = delete(ChatHistory).where(...)
        await session.execute(stmt)
        # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–ø–∞–¥–µ—Ç - –≤—Å–µ –æ—Ç–∫–∞—Ç–∏—Ç—Å—è
```

---

### 4. –í–∞–ª–∏–¥–∞—Ü–∏—è image_data –¥–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ –ü–û–°–õ–ï `base64.decode()`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–ª–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–≥—Ä–æ–º–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏ –∏—Å—á–µ—Ä–ø–∞—Ç—å –ø–∞–º—è—Ç—å.

**–†–∏—Å–∫:** DoS –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ memory exhaustion.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ base64 —Å—Ç—Ä–æ–∫–∏ –î–û –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
- –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è overhead base64 (~33%) ‚Üí —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 1.4
- Double-check –ø–æ—Å–ª–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–§–∞–π–ª:**
- `server/ai.py:430-462` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `process_image_data`

**–ö–æ–¥:**
```python
MAX_BASE64_SIZE = MAX_IMAGE_SIZE * 1.4  # –£—á–∏—Ç—ã–≤–∞–µ–º base64 overhead

# SECURITY: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –î–û –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
if len(image_data) > MAX_BASE64_SIZE:
    logging.warning(f"Base64 too large: {len(image_data)} chars")
    return None

# –î–µ–∫–æ–¥–∏—Ä—É–µ–º
image_bytes = base64.b64decode(image_data)

# Double-check –ø–æ—Å–ª–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
if len(image_bytes) > MAX_IMAGE_SIZE:
    return None
```

---

### 5. Cleanup —Å—Ç–∞—Ä—ã—Ö chat_history

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∞–±–ª–∏—Ü–∞ `chat_history` —Ä–æ—Å–ª–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ, –Ω–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è.

**–†–∏—Å–∫:** –ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞, –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ë–î.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `cleanup_old_chat_history(days_to_keep=30)` –≤ `database.py`
- –°–æ–∑–¥–∞–Ω admin endpoint `/admin/cleanup_chat_history` –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
- JWT –∑–∞—â–∏—Ç–∞ –∏ rate limiting (1/hour)

**–§–∞–π–ª—ã:**
- `server/database.py:685-723` - —Ñ—É–Ω–∫—Ü–∏—è cleanup
- `main.py:466-488` - admin endpoint

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
# –î–æ–±–∞–≤–∏—Ç—å –≤ main.py —Å APScheduler:
from apscheduler.schedulers.asyncio import AsyncIOScheduler
scheduler = AsyncIOScheduler()
scheduler.add_job(cleanup_old_chat_history, 'interval', days=1, kwargs={'days_to_keep': 30})
scheduler.start()

# –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ API:
POST /admin/cleanup_chat_history?days_to_keep=30
Authorization: Bearer <JWT_TOKEN>
```

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –õ–æ–≥–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

### 6. –í–∞–ª–∏–¥–∞—Ü–∏—è charge_id –¥–ª–∏–Ω—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** `charge_id` –º–æ–≥ –±—ã—Ç—å –ª—é–±–æ–π –¥–ª–∏–Ω—ã, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è DoS –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ –∑–∞–ø–∏—Å—å –æ–≥—Ä–æ–º–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –≤ –ë–î.

**–†–∏—Å–∫:** DoS –Ω–∞ –ë–î, –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –∫–æ–ª–æ–Ω–∫–∏: `String(255)`
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `activate_premium_subscription`:
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ `len(charge_id) > 255`
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –∞—Ç–∞–∫–∏
  - –í–æ–∑–≤—Ä–∞—Ç `False` –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

**–§–∞–π–ª—ã:**
- `server/models.py:52` - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ —Å—Ö–µ–º–µ
- `server/database.py:699-702` - –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–ö–æ–¥:**
```python
# –ú–æ–¥–µ–ª—å:
last_processed_payment_charge_id: Mapped[str] = mapped_column(String(255), nullable=True)

# –í–∞–ª–∏–¥–∞—Ü–∏—è:
if charge_id and len(charge_id) > 255:
    logging.error(f"charge_id too long: {len(charge_id)} chars (max 255)")
    return False
```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª–æ–≤ | –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | –í—Ä–µ–º—è |
|----------|--------|------------|-------|
| Timezone-aware datetime | 2 | ~50 | 1 —á–∞—Å |
| Hardcoded httpx timeout | 3 | ~10 | 30 –º–∏–Ω |
| –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ summarizer | 1 | ~60 | 2 —á–∞—Å–∞ |
| –í–∞–ª–∏–¥–∞—Ü–∏—è image_data | 1 | ~15 | 30 –º–∏–Ω |
| Cleanup chat_history | 2 | ~70 | 2 —á–∞—Å–∞ |
| –í–∞–ª–∏–¥–∞—Ü–∏—è charge_id | 2 | ~10 | 20 –º–∏–Ω |
| **–í–°–ï–ì–û** | **8** | **~215** | **~7 —á–∞—Å–æ–≤** |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ—à–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞:

```bash
python -m py_compile server/models.py         # ‚úÖ OK
python -m py_compile server/database.py       # ‚úÖ OK
python -m py_compile server/summarizer.py     # ‚úÖ OK
python -m py_compile server/ai.py             # ‚úÖ OK
python -m py_compile config.py                # ‚úÖ OK
python -m py_compile bot/bot.py               # ‚úÖ OK
python -m py_compile main.py                  # ‚úÖ OK
```

---

## üöÄ Deployment

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î:
```bash
alembic upgrade head
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å .env —Ñ–∞–π–ª:
```bash
# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
HTTPX_TIMEOUT=180
HTTPX_CONNECT_TIMEOUT=10
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã:
```bash
docker-compose down
docker-compose up --build -d
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
```bash
docker-compose logs -f api
docker-compose logs -f bot
```

### 5. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cleanup:
–†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ APScheduler –≤ `main.py` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cron –¥–ª—è –≤—ã–∑–æ–≤–∞ `/admin/cleanup_chat_history`.

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã `chat_history`
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 1M –∑–∞–ø–∏—Å–µ–π

2. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å APScheduler –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ cleanup
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Kubernetes CronJob

3. **Backup:**
   - –î–µ–ª–∞—Ç—å backup –ë–î –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤—ã–º cleanup
   - –•—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏–≤–µ (S3, etc.)

4. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
   - –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π `days_to_keep` (30-90 –¥–Ω–µ–π)
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `HTTPX_TIMEOUT` –ø–æ–¥ –≤–∞—à–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:** ‚úÖ –î–∞ (–ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏)

