# üîí –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ EvolveAI

> **–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** –Ø–Ω–≤–∞—Ä—å 2025  
> **–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** Main branch  
> **–°—Ç–∞—Ç—É—Å:** –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω

---

## üìã Executive Summary

–ü—Ä–æ–≤–µ–¥–µ–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ AI-–±–æ—Ç–∞ –Ω–∞ –±–∞–∑–µ Telegram. –ü—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç **—Ö–æ—Ä–æ—à–∏–π —É—Ä–æ–≤–µ–Ω—å –∑—Ä–µ–ª–æ—Å—Ç–∏** –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ **15 –∑–æ–Ω –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è**, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö **4 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ**, **6 –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞** –∏ **5 —Å—Ä–µ–¥–Ω–µ–≥–æ**.

### –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:
‚úÖ **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- JWT-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö endpoints
- SQL Injection –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—é
- Rate limiting –Ω–∞ –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö API
- Circuit Breaker –¥–ª—è Redis
- Secrets –≤ .env (–Ω–µ –≤ –∫–æ–¥–µ)
- RBAC —á–µ—Ä–µ–∑ premium –ø–æ–¥–ø–∏—Å–∫–∏
- Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è —Å –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è:**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å PII
- –ù–µ—Ç HTTPS –¥–ª—è API (—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Docker —Å–µ—Ç–∏)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –Ω–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üéØ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (CVSS 9.0-10.0) üî¥

#### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∏–º—è, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π) —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ.

**–§–∞–π–ª—ã:** `server/models.py` (UserProfile, ChatHistory)

**–†–∏—Å–∫:**
- –ü—Ä–∏ —É—Ç–µ—á–∫–µ –¥–∞–º–ø–∞ –ë–î –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã
- –ù–∞—Ä—É—à–µ–Ω–∏–µ GDPR (Article 32 - Security of processing)
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞—Ç–∞–∫–∏ —á–µ—Ä–µ–∑ SQL Injection (–Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∑–∞—â–∏—Ç—É)

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:**
```python
# server/models.py:40-60
class UserProfile(Base):
    __tablename__ = 'userprofiles'
    user_id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(100), nullable=True)  # ‚ùå –û—Ç–∫—Ä—ã—Ç—ã–π —Ç–µ–∫—Å—Ç
    birth_date: Mapped[date] = mapped_column(nullable=True)        # ‚ùå –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
from cryptography.fernet import Fernet
import os

# 1. –î–æ–±–∞–≤–∏—Ç—å –≤ config.py
ENCRYPTION_KEY = os.getenv("ENCRYPTION_KEY")  # Generate: Fernet.generate_key()
cipher_suite = Fernet(ENCRYPTION_KEY.encode())

# 2. –°–æ–∑–¥–∞—Ç—å helper —Ñ—É–Ω–∫—Ü–∏–∏ –≤ server/encryption.py
def encrypt_field(value: str) -> str:
    """–®–∏—Ñ—Ä—É–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î."""
    if not value:
        return None
    return cipher_suite.encrypt(value.encode()).decode()

def decrypt_field(encrypted_value: str) -> str:
    """–†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –ø–æ–ª—è –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑ –ë–î."""
    if not encrypted_value:
        return None
    return cipher_suite.decrypt(encrypted_value.encode()).decode()

# 3. –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª–∏
class UserProfile(Base):
    __tablename__ = 'userprofiles'
    user_id: Mapped[int] = mapped_column(primary_key=True)
    _name: Mapped[str] = mapped_column("name", String(200), nullable=True)  # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    _birth_date: Mapped[str] = mapped_column("birth_date", String(200), nullable=True)
    
    @property
    def name(self) -> str:
        return decrypt_field(self._name)
    
    @name.setter
    def name(self, value: str):
        self._name = encrypt_field(value)
    
    @property
    def birth_date(self) -> date:
        decrypted = decrypt_field(self._birth_date)
        return date.fromisoformat(decrypted) if decrypted else None
    
    @birth_date.setter
    def birth_date(self, value: date):
        self._birth_date = encrypt_field(value.isoformat())
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 4-6 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è (—Ç—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î)

---

#### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
**–û–ø–∏—Å–∞–Ω–∏–µ:** Endpoint `/buy_premium` –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π –Ω–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –∑–∞—â–∏—Ç—ã –æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞—Ç–∞–∫ –Ω–∞ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É.

**–§–∞–π–ª—ã:** 
- `bot/handlers/payments.py:23-53`
- `main.py` (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `/payment` endpoint rate limiting)

**–†–∏—Å–∫:**
- –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∏–Ω–≤–æ–π—Å–æ–≤
- DoS –∞—Ç–∞–∫–∞ –Ω–∞ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É Telegram
- –ò—Å—Ç–æ—â–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ PAYMENT_PROVIDER_TOKEN

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:**
```python
# bot/handlers/payments.py:23
@router.message(Command("buy_premium"))
async def buy_premium_command(message: types.Message):
    # ‚ùå –ù–µ—Ç rate limiting –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤
    await callback.bot.send_invoice(...)
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# 1. –î–æ–±–∞–≤–∏—Ç—å FSM –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–ø–ª–∞—Ç—ã
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext

class PaymentStates(StatesGroup):
    choosing_plan = State()
    pending_payment = State()

# 2. –î–æ–±–∞–≤–∏—Ç—å rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
from collections import defaultdict
from datetime import datetime, timedelta

payment_attempts = defaultdict(list)  # user_id: [timestamp1, timestamp2, ...]
MAX_PAYMENT_ATTEMPTS = 3  # –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –≤ —á–∞—Å

@router.message(Command("buy_premium"))
async def buy_premium_command(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    now = datetime.now()
    
    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
    payment_attempts[user_id] = [
        t for t in payment_attempts[user_id]
        if now - t < timedelta(hours=1)
    ]
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
    if len(payment_attempts[user_id]) >= MAX_PAYMENT_ATTEMPTS:
        await message.answer(
            "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –æ–ø–ª–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —á–∞—Å."
        )
        return
    
    payment_attempts[user_id].append(now)
    await state.set_state(PaymentStates.choosing_plan)
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥

# 3. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é payload –≤ pre_checkout_query_handler
@router.pre_checkout_query()
async def pre_checkout_query_handler(pre_checkout_query: PreCheckoutQuery):
    payload = pre_checkout_query.invoice_payload
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ payload
    try:
        parts = payload.split("_")
        if len(parts) != 3 or parts[0] != "premium":
            raise ValueError("Invalid payload format")
        
        subscription_type = parts[1]
        user_id_from_payload = int(parts[2])
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è user_id
        if user_id_from_payload != pre_checkout_query.from_user.id:
            logger.warning(f"Payload user_id mismatch: {user_id_from_payload} != {pre_checkout_query.from_user.id}")
            await pre_checkout_query.answer(ok=False, error_message="–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞")
            return
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏
        valid_types = ["1_month", "3_months", "6_months", "12_months"]
        if subscription_type not in valid_types:
            raise ValueError(f"Invalid subscription type: {subscription_type}")
            
    except (ValueError, IndexError) as e:
        logger.error(f"Invalid payment payload: {payload}, error: {e}")
        await pre_checkout_query.answer(ok=False, error_message="–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–ª–∞—Ç–µ–∂–∞")
        return
    
    await pre_checkout_query.answer(ok=True)

# 4. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
@router.message(F.successful_payment)
async def successful_payment_handler(message: types.Message, client: httpx.AsyncClient):
    payment = message.successful_payment
    user_id = message.from_user.id
    
    # AUDIT LOG: –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
    logger.info(
        f"PAYMENT_SUCCESS: user_id={user_id}, "
        f"amount={payment.total_amount}, "
        f"currency={payment.currency}, "
        f"charge_id={payment.telegram_payment_charge_id}, "
        f"payload={payment.invoice_payload}, "
        f"provider_charge_id={payment.provider_payment_charge_id}"
    )
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 3-4 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

---

#### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å PII (Personally Identifiable Information)
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç –≤ –∫–æ–¥–µ –ª–æ–≥–∏—Ä—É—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏, —á—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç GDPR –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —É—Ç–µ—á–∫–µ —á–µ—Ä–µ–∑ –ª–æ–≥–∏.

**–§–∞–π–ª—ã:** 
- `server/ai.py` (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π)
- `server/database.py` (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å PII)
- `bot/handlers/messages.py`

**–†–∏—Å–∫:**
- –ù–∞—Ä—É—à–µ–Ω–∏–µ GDPR Article 5 (Data minimisation)
- –£—Ç–µ—á–∫–∞ PII —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ù–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ —Å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:**
```python
# –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç –≤ –∫–æ–¥–µ
logging.debug(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: '{final_response}'")
# ‚ùå final_response –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

logging.debug(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ–∞–∫—Ç–∞ –¥–ª—è user_id {user_id}")
# ‚ùå –§–∞–∫—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º (–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, —Ñ–∏–Ω–∞–Ω—Å—ã)
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# 1. –°–æ–∑–¥–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ PII –≤ utils/logging_helpers.py
import re
from typing import Any

def mask_pii(text: str, mask_char: str = "*") -> str:
    """
    –ú–∞—Å–∫–∏—Ä—É–µ—Ç PII –≤ —Å—Ç—Ä–æ–∫–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
    
    –ú–∞—Å–∫–∏—Ä—É–µ—Ç:
    - Email –∞–¥—Ä–µ—Å–∞
    - –ù–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
    - –î–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
    - –ò–º–µ–Ω–∞ (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
    """
    if not text:
        return text
    
    # Email
    text = re.sub(r'\b[\w.-]+@[\w.-]+\.\w+\b', '[EMAIL]', text)
    
    # –¢–µ–ª–µ—Ñ–æ–Ω—ã (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)
    text = re.sub(r'\+?[78][\s-]?\(?\d{3}\)?[\s-]?\d{3}[\s-]?\d{2}[\s-]?\d{2}', '[PHONE]', text)
    
    # –î–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è (DD.MM.YYYY –∏–ª–∏ YYYY-MM-DD)
    text = re.sub(r'\b\d{2}\.\d{2}\.\d{4}\b|\b\d{4}-\d{2}-\d{2}\b', '[DATE]', text)
    
    return text

def safe_log_user_message(user_id: int, message: str, max_length: int = 50) -> str:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        message: –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        max_length: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    
    Returns:
        –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    """
    masked = mask_pii(message)
    truncated = masked[:max_length] + "..." if len(masked) > max_length else masked
    return f"user_{user_id}: {truncated}"

# 2. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
# –í server/ai.py
from utils.logging_helpers import safe_log_user_message

# –ë–´–õ–û:
# logging.debug(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: '{final_response}'")

# –°–¢–ê–õ–û:
logging.debug(f"–û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è user_{user_id}, –¥–ª–∏–Ω–∞: {len(final_response)} —Å–∏–º–≤–æ–ª–æ–≤")

# –í server/database.py
# –ë–´–õ–û:
# logging.debug(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ–∞–∫—Ç–∞ –¥–ª—è user_id {user_id}")

# –°–¢–ê–õ–û:
logging.debug(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∞ –¥–ª—è user_{user_id}, –∫–∞—Ç–µ–≥–æ—Ä–∏—è: {category}")

# 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤ –≤ docker-compose.yml (—É–∂–µ –µ—Å—Ç—å)
# logging:
#   driver: "json-file"
#   options:
#     max-size: "10m"
#     max-file: "3"

# 4. –î–æ–±–∞–≤–∏—Ç—å –≤ .gitignore –ª–æ–≥–∏ —Å PII
# logs/
# *.log

# 5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å structlog –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
import structlog

structlog.configure(
    processors=[
        structlog.processors.add_log_level,
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.StackInfoRenderer(),
        structlog.processors.format_exc_info,
        structlog.processors.JSONRenderer()  # JSON –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–µ–∑ PII
    ],
)

logger = structlog.get_logger()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
logger.info("user_message_received", user_id=user_id, message_length=len(message))
# –í–º–µ—Å—Ç–æ logger.info(f"Received: {message}")
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (GDPR compliance)  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 6-8 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è-–í—ã—Å–æ–∫–∞—è

---

#### 4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ HTTPS –¥–ª—è API endpoints
**–û–ø–∏—Å–∞–Ω–∏–µ:** API FastAPI –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ HTTP –≤–Ω—É—Ç—Ä–∏ Docker —Å–µ—Ç–∏, –Ω–æ –Ω–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è HTTPS/TLS –¥–ª—è external access.

**–§–∞–π–ª—ã:** `docker-compose.yml`, `main.py`

**–†–∏—Å–∫:**
- Man-in-the-middle –∞—Ç–∞–∫–∏
- –ü–µ—Ä–µ—Ö–≤–∞—Ç JWT —Ç–æ–∫–µ–Ω–æ–≤
- –ü–µ—Ä–µ—Ö–≤–∞—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:**
```yaml
# docker-compose.yml:20
api:
  ports:
    - "8000:8000"  # ‚ùå –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –±–µ–∑ TLS
```

**–†–µ—à–µ–Ω–∏–µ:**
```yaml
# 1. –î–æ–±–∞–≤–∏—Ç—å nginx reverse proxy —Å TLS –≤ docker-compose.yml
services:
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  api:
    # ... existing config
    ports:
      - "8000"  # ‚úÖ –£–±–∏—Ä–∞–µ–º –ø—Ä—è–º–æ–π external –¥–æ—Å—Ç—É–ø
    expose:
      - "8000"

# 2. –°–æ–∑–¥–∞—Ç—å nginx/nginx.conf
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    location / {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Rate limiting –Ω–∞ nginx —É—Ä–æ–≤–Ω–µ
        limit_req zone=api burst=10 nodelay;
    }
}

http {
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;
}

# 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è self-signed —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è development
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#   -keyout nginx/ssl/key.pem -out nginx/ssl/cert.pem

# 4. –î–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Let's Encrypt
# certbot certonly --webroot -w /var/www/html -d your-domain.com
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–¥–ª—è production)  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è-–°—Ä–µ–¥–Ω—è—è

---

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (CVSS 7.0-8.9) üü†

#### 5. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è image_data
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–µ–∫–æ–¥–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∞, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ DoS –∏–ª–∏ RCE —á–µ—Ä–µ–∑ malicious images.

**–§–∞–π–ª—ã:** `server/ai.py:460-510`

**–†–∏—Å–∫:**
- DoS —á–µ—Ä–µ–∑ –∑–∞–≥—Ä—É–∑–∫—É –æ–≥—Ä–æ–º–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- Memory exhaustion
- –í–æ–∑–º–æ–∂–Ω–∞—è RCE —á–µ—Ä–µ–∑ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ Pillow

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:**
```python
# server/ai.py:485
async def process_image_data(image_data: str | None, user_id: int) -> genai_types.Part | None:
    if not image_data:
        return None
    try:
        image_bytes = base64.b64decode(image_data)  # ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞
        image = Image.open(io.BytesIO(image_bytes))  # ‚ùå –ú–æ–∂–µ—Ç –±—ã—Ç—å ZIP bomb
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
from PIL import Image, UnidentifiedImageError
import io
import base64
from config import MAX_IMAGE_SIZE_MB

MAX_IMAGE_SIZE_BYTES = MAX_IMAGE_SIZE_MB * 1024 * 1024  # 10MB
MAX_IMAGE_DIMENSIONS = (4096, 4096)  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
ALLOWED_FORMATS = {'JPEG', 'PNG', 'GIF', 'WEBP'}

async def process_image_data(image_data: str | None, user_id: int) -> genai_types.Part | None:
    if not image_data:
        return None
    
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã base64 –ü–ï–†–ï–î –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        if len(image_data) > MAX_IMAGE_SIZE_BYTES * 1.37:  # base64 overhead ~37%
            logging.warning(f"Image too large for user {user_id}: {len(image_data)} bytes (base64)")
            raise ValueError(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º—É–º {MAX_IMAGE_SIZE_MB}MB")
        
        # 2. –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        try:
            image_bytes = base64.b64decode(image_data, validate=True)
        except Exception as e:
            logging.warning(f"Invalid base64 image from user {user_id}: {e}")
            raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Å–ª–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
        if len(image_bytes) > MAX_IMAGE_SIZE_BYTES:
            logging.warning(f"Decoded image too large for user {user_id}: {len(image_bytes)} bytes")
            raise ValueError(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º—É–º {MAX_IMAGE_SIZE_MB}MB")
        
        # 4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç ZIP bombs
        image_stream = io.BytesIO(image_bytes)
        try:
            image = Image.open(image_stream)
            
            # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
            if image.format not in ALLOWED_FORMATS:
                logging.warning(f"Unsupported image format from user {user_id}: {image.format}")
                raise ValueError(f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç. –†–∞–∑—Ä–µ—à–µ–Ω—ã: {', '.join(ALLOWED_FORMATS)}")
            
            # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç decompression bombs
            if image.width > MAX_IMAGE_DIMENSIONS[0] or image.height > MAX_IMAGE_DIMENSIONS[1]:
                logging.warning(f"Image dimensions too large for user {user_id}: {image.width}x{image.height}")
                raise ValueError(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º—É–º {MAX_IMAGE_DIMENSIONS[0]}x{MAX_IMAGE_DIMENSIONS[1]}")
            
            # 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ decompression bomb (Pillow –∑–∞—â–∏—Ç–∞)
            try:
                image.verify()  # –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å
                image_stream.seek(0)  # Reset –ø–æ—Å–ª–µ verify
                image = Image.open(image_stream)  # Reopen –ø–æ—Å–ª–µ verify
            except Exception as e:
                logging.warning(f"Image verification failed for user {user_id}: {e}")
                raise ValueError("–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
            
            # 8. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ RGB –∏ resize –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
            if image.mode != 'RGB':
                image = image.convert('RGB')
            
            # 9. Resize –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º aspect ratio)
            if image.width > 2048 or image.height > 2048:
                image.thumbnail((2048, 2048), Image.Resampling.LANCZOS)
                logging.debug(f"Image resized for user {user_id} to {image.width}x{image.height}")
            
            # 10. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ bytes –¥–ª—è API
            output_stream = io.BytesIO()
            image.save(output_stream, format='JPEG', quality=85)
            optimized_bytes = output_stream.getvalue()
            
            logging.debug(f"Image processed for user {user_id}: {len(image_bytes)} -> {len(optimized_bytes)} bytes")
            
            return genai_types.Part(
                inline_data=genai_types.Blob(
                    mime_type='image/jpeg',
                    data=optimized_bytes
                )
            )
            
        except UnidentifiedImageError:
            logging.warning(f"Unidentifiable image from user {user_id}")
            raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
        
    except ValueError as e:
        # User-friendly –æ—à–∏–±–∫–∏
        logging.info(f"Image validation failed for user {user_id}: {e}")
        raise
    except Exception as e:
        logging.error(f"Unexpected error processing image for user {user_id}: {e}", exc_info=True)
        raise ValueError("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")

# 11. –î–æ–±–∞–≤–∏—Ç—å –≤ .env.example –ª–∏–º–∏—Ç—ã
# MAX_IMAGE_SIZE_MB=10
# MAX_IMAGE_WIDTH=4096
# MAX_IMAGE_HEIGHT=4096
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

---

#### 6. JWT_SECRET –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∞–±—ã–º
**–û–ø–∏—Å–∞–Ω–∏–µ:** –í–∞–ª–∏–¥–∞—Ü–∏—è JWT_SECRET —Ç–æ–ª—å–∫–æ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ, –Ω–æ –Ω–µ –Ω–∞ —ç–Ω—Ç—Ä–æ–ø–∏—é. –°–ª–∞–±—ã–π secret –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–æ–±—Ä–∞–Ω –±—Ä—É—Ç—Ñ–æ—Ä—Å–æ–º.

**–§–∞–π–ª—ã:** `config.py:132-134`

**–†–∏—Å–∫:**
- –ë—Ä—É—Ç—Ñ–æ—Ä—Å JWT —Ç–æ–∫–µ–Ω–æ–≤
- –ü–æ–¥–¥–µ–ª–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ —Å admin –ø—Ä–∞–≤–∞–º–∏
- –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ API

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:**
```python
# config.py:132
JWT_SECRET = os.getenv("JWT_SECRET")
if not JWT_SECRET:
    raise ValueError("JWT_SECRET –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤ .env —Ñ–∞–π–ª–µ.")
# ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª–∏–Ω—ã –∏ —ç–Ω—Ç—Ä–æ–ø–∏–∏
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
import os
import secrets
import hashlib

JWT_SECRET = os.getenv("JWT_SECRET")

# –í–∞–ª–∏–¥–∞—Ü–∏—è JWT_SECRET
if not JWT_SECRET:
    raise ValueError("JWT_SECRET –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤ .env —Ñ–∞–π–ª–µ.")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã
if len(JWT_SECRET) < 32:
    raise ValueError(
        "JWT_SECRET —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π! –ú–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞.\n"
        f"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–ª—é—á: openssl rand -hex 32"
    )

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–Ω—Ç—Ä–æ–ø–∏–∏ (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
unique_chars = len(set(JWT_SECRET))
if unique_chars < 16:
    logging.warning(
        f"JWT_SECRET –∏–º–µ–µ—Ç –Ω–∏–∑–∫—É—é —ç–Ω—Ç—Ä–æ–ø–∏—é ({unique_chars} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤). "
        "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–π –∫–ª—é—á."
    )

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
def generate_secure_secret() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–π JWT secret."""
    return secrets.token_hex(32)  # 64 hex —Å–∏–º–≤–æ–ª–∞ = 256 –±–∏—Ç

# –î–æ–±–∞–≤–∏—Ç—å –≤ README.md –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
"""
## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT_SECRET

–î–ª—è production –æ–∫—Ä—É–∂–µ–Ω–∏—è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π JWT_SECRET:

```bash
# Linux/macOS
openssl rand -hex 32

# Python
python -c "import secrets; print(secrets.token_hex(32))"

# PowerShell
[System.Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))
```

‚ö†Ô∏è –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –ø—Ä–∏–º–µ—Ä–∞!
"""
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 30 –º–∏–Ω—É—Ç  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

---

#### 7. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ CSRF –∑–∞—â–∏—Ç—ã –Ω–∞ API endpoints
**–û–ø–∏—Å–∞–Ω–∏–µ:** FastAPI endpoints –Ω–µ –∏–º–µ—é—Ç CSRF —Ç–æ–∫–µ–Ω–æ–≤, —á—Ç–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç CSRF –∞—Ç–∞–∫–∏ (—Ö–æ—Ç—è SameSite cookies –∏ CORS –ø–æ–º–æ–≥–∞—é—Ç).

**–§–∞–π–ª—ã:** `main.py`

**–†–∏—Å–∫:**
- CSRF –∞—Ç–∞–∫–∏ –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
- –§–∏—à–∏–Ω–≥ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
# 1. –î–æ–±–∞–≤–∏—Ç—å CORS middleware —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://your-frontend-domain.com"],  # ‚ùå –ù–ï "*"
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["Authorization", "Content-Type", "X-CSRF-Token"],
)

# 2. –î–ª—è form submissions –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Double Submit Cookie pattern
from fastapi import Cookie, Header, HTTPException
import secrets

def generate_csrf_token() -> str:
    return secrets.token_urlsafe(32)

async def verify_csrf_token(
    csrf_token_cookie: str = Cookie(None, alias="csrf_token"),
    csrf_token_header: str = Header(None, alias="X-CSRF-Token")
):
    if not csrf_token_cookie or not csrf_token_header:
        raise HTTPException(status_code=403, detail="CSRF token missing")
    
    if csrf_token_cookie != csrf_token_header:
        raise HTTPException(status_code=403, detail="CSRF token mismatch")
    
    return csrf_token_cookie

# 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö endpoints
@app.post("/profile")
@limiter.limit("20/minute")
async def create_or_update_profile_handler(
    request: Request,
    profile_update: ProfileUpdate,
    csrf_token: str = Depends(verify_csrf_token)  # ‚úÖ CSRF –∑–∞—â–∏—Ç–∞
):
    await create_or_update_profile(profile_update.user_id, profile_update.data.dict())
    return {"message": "–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"}

# 4. Endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
@app.get("/csrf-token")
async def get_csrf_token(response: Response):
    token = generate_csrf_token()
    response.set_cookie(
        key="csrf_token",
        value=token,
        httponly=True,
        secure=True,  # –¢–æ–ª—å–∫–æ HTTPS
        samesite="strict"
    )
    return {"csrf_token": token}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π (–µ—Å–ª–∏ API –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –≤–µ–±)  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 1-2 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è-–°—Ä–µ–¥–Ω—è—è

---

#### 8. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞—É–¥–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ premium —Ñ—É–Ω–∫—Ü–∏—è–º
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è premium —Ñ—É–Ω–∫—Ü–∏–π (TTS, unlimited messages), —á—Ç–æ –∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞.

**–§–∞–π–ª—ã:** `server/tts.py`, `server/database.py:check_message_limit`

**–†–∏—Å–∫:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ñ–æ—Ä–µ–Ω–∑–∏–∫–∏ –ø—Ä–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞—Ö
- –ù–∞—Ä—É—à–µ–Ω–∏–µ compliance —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
```python
# 1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∞—É–¥–∏—Ç–∞ –≤ server/models.py
class AuditLog(Base):
    __tablename__ = 'audit_logs'
    
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(nullable=False, index=True)
    action: Mapped[str] = mapped_column(String(100), nullable=False)
    resource: Mapped[str] = mapped_column(String(200), nullable=True)
    ip_address: Mapped[str] = mapped_column(String(45), nullable=True)  # IPv6 support
    user_agent: Mapped[str] = mapped_column(String(500), nullable=True)
    metadata: Mapped[dict] = mapped_column(JSON, nullable=True)
    timestamp: Mapped[datetime] = mapped_column(default=lambda: datetime.now(timezone.utc))
    
    __table_args__ = (
        Index('idx_audit_user_timestamp', 'user_id', 'timestamp'),
        Index('idx_audit_action', 'action'),
    )

# 2. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ server/database.py
async def log_audit_event(
    user_id: int,
    action: str,
    resource: str = None,
    ip_address: str = None,
    user_agent: str = None,
    metadata: dict = None
):
    """
    –õ–æ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –∞—É–¥–∏—Ç–∞ –¥–ª—è compliance –∏ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        action: –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (TTS_GENERATED, PREMIUM_ACTIVATED, MESSAGE_SENT)
        resource: –†–µ—Å—É—Ä—Å (endpoint, file)
        ip_address: IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
        user_agent: User-Agent –∫–ª–∏–µ–Ω—Ç–∞
        metadata: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–±–µ–∑ PII!)
    """
    try:
        async with async_session_factory() as session:
            audit_entry = AuditLog(
                user_id=user_id,
                action=action,
                resource=resource,
                ip_address=ip_address,
                user_agent=user_agent,
                metadata=metadata
            )
            session.add(audit_entry)
            await session.commit()
    except Exception as e:
        # –ù–µ –ø–∞–¥–∞–µ–º –µ—Å–ª–∏ –∞—É–¥–∏—Ç –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è
        logging.error(f"Failed to log audit event: {e}", exc_info=True)

# 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
# –í server/tts.py
async def create_telegram_voice_message(text_to_speak: str, output_file_object: io.BytesIO, user_id: int) -> bool:
    if not TTS_CLIENT:
        logging.error("–ö–ª–∏–µ–Ω—Ç TTS –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        return False
    
    try:
        response = await call_tts_api_with_retry(text_to_speak)
        
        # AUDIT LOG
        await log_audit_event(
            user_id=user_id,
            action="TTS_GENERATED",
            resource="gemini-2.5-flash-preview-tts",
            metadata={
                "text_length": len(text_to_speak),
                "audio_size_bytes": len(pcm_data) if pcm_data else 0,
                "usage_metadata": str(response.usage_metadata) if hasattr(response, 'usage_metadata') else None
            }
        )
        
        # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
        return True
    except Exception as e:
        # AUDIT LOG –¥–ª—è –æ—à–∏–±–æ–∫ —Ç–æ–∂–µ
        await log_audit_event(
            user_id=user_id,
            action="TTS_FAILED",
            resource="gemini-2.5-flash-preview-tts",
            metadata={"error": str(e)}
        )
        return False

# –í main.py –¥–ª—è –ø—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
@app.post("/activate_premium")
async def activate_premium_handler(
    request: Request,
    activate_request: dict = Body(...),
    authenticated_user_id: int = Depends(verify_token)
):
    user_id = activate_request.get("user_id")
    duration_days = activate_request.get("duration_days", 30)
    charge_id = activate_request.get("charge_id")
    
    # AUDIT LOG
    await log_audit_event(
        user_id=user_id,
        action="PREMIUM_ACTIVATED",
        resource="/activate_premium",
        ip_address=get_remote_address(request),
        user_agent=request.headers.get("user-agent"),
        metadata={
            "duration_days": duration_days,
            "charge_id": charge_id,
            "authenticated_user_id": authenticated_user_id
        }
    )
    
    success = await activate_premium_subscription(user_id, duration_days, charge_id)
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥

# 4. Endpoint –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞—É–¥–∏—Ç–∞
@app.get("/admin/audit")
@limiter.limit("10/minute")
async def get_audit_logs(
    request: Request,
    user_id: int = None,
    action: str = None,
    limit: int = 100,
    admin_user_id: int = Depends(verify_token)  # TODO: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É admin —Ä–æ–ª–∏
):
    """–ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –∞—É–¥–∏—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)."""
    # TODO: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ admin_user_id –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    
    async with async_session_factory() as session:
        query = select(AuditLog)
        
        if user_id:
            query = query.where(AuditLog.user_id == user_id)
        if action:
            query = query.where(AuditLog.action == action)
        
        query = query.order_by(desc(AuditLog.timestamp)).limit(limit)
        
        result = await session.execute(query)
        logs = result.scalars().all()
        
        return {"logs": [log.__dict__ for log in logs]}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 3-4 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

---

#### 9. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å Rate Limit Bypass —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ IP
**–û–ø–∏—Å–∞–Ω–∏–µ:** Rate limiting –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ IP –∞–¥—Ä–µ—Å–µ (`get_remote_address`), –∫–æ—Ç–æ—Ä—ã–π –ª–µ–≥–∫–æ –æ–±—Ö–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ VPN.

**–§–∞–π–ª—ã:** `main.py:40-46`

**–†–∏—Å–∫:**
- –û–±—Ö–æ–¥ rate limiting
- DoS –∞—Ç–∞–∫–∏
- Abuse –ø—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
```python
# 1. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π rate limiting: IP + user_id
from slowapi import Limiter
from fastapi import Request

def get_combined_limiter_key(request: Request) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è rate limiting.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–∞–∫ IP, —Ç–∞–∫ –∏ user_id –∏–∑ JWT (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω).
    """
    ip = get_remote_address(request)
    
    # –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å user_id –∏–∑ Authorization header
    auth_header = request.headers.get("authorization", "")
    if auth_header.startswith("Bearer "):
        try:
            token = auth_header.split(" ")[1]
            payload = jwt.decode(token, config.JWT_SECRET, algorithms=[config.JWT_ALGORITHM])
            user_id = payload.get("sub")
            if user_id:
                return f"user:{user_id}"  # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç user_id
        except Exception:
            pass  # Fallback –∫ IP
    
    return f"ip:{ip}"

limiter = Limiter(key_func=get_combined_limiter_key)

# 2. –†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∏ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
from slowapi.util import get_remote_address

@app.post("/chat")
@limiter.limit("30/minute;100/hour")  # –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–∏–º–∏—Ç
async def chat_handler(
    request: Request,
    chat: ChatRequest,
    user_id: int = Depends(verify_token)
):
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ user-level –ª–∏–º–∏—Ç
    # –£–∂–µ –∑–∞—â–∏—â–µ–Ω—ã —á–µ—Ä–µ–∑ get_combined_limiter_key
    # ...

# 3. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π rate limiting –Ω–∞ –æ—Å–Ω–æ–≤–µ reputation
from collections import defaultdict
from datetime import datetime, timedelta

user_reputation = defaultdict(lambda: {"score": 100, "violations": []})

async def check_user_reputation(user_id: int, request: Request) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–ø—É—Ç–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ—Ç –ª–∏–º–∏—Ç—ã.
    
    Returns:
        True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, False –µ—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
    """
    rep = user_reputation[user_id]
    now = datetime.now()
    
    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è (—Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
    rep["violations"] = [
        v for v in rep["violations"]
        if now - v["timestamp"] < timedelta(hours=24)
    ]
    
    # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º score
    rep["score"] = max(0, 100 - len(rep["violations"]) * 20)
    
    # –ë–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ score —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π
    if rep["score"] < 20:
        await log_audit_event(
            user_id=user_id,
            action="USER_BLOCKED_LOW_REPUTATION",
            ip_address=get_remote_address(request),
            metadata={"score": rep["score"], "violations": len(rep["violations"])}
        )
        return False
    
    return True

def record_rate_limit_violation(user_id: int):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–µ rate limit."""
    user_reputation[user_id]["violations"].append({
        "timestamp": datetime.now(),
        "type": "rate_limit_exceeded"
    })

# 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ middleware
@app.middleware("http")
async def reputation_middleware(request: Request, call_next):
    # –ò–∑–≤–ª–µ–∫–∞–µ–º user_id –∏–∑ —Ç–æ–∫–µ–Ω–∞
    auth_header = request.headers.get("authorization", "")
    user_id = None
    
    if auth_header.startswith("Bearer "):
        try:
            token = auth_header.split(" ")[1]
            payload = jwt.decode(token, config.JWT_SECRET, algorithms=[config.JWT_ALGORITHM])
            user_id = int(payload.get("sub"))
        except Exception:
            pass
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–ø—É—Ç–∞—Ü–∏—é
    if user_id and not await check_user_reputation(user_id, request):
        return Response(
            content='{"detail":"Account temporarily blocked due to abuse"}',
            status_code=429,
            media_type="application/json"
        )
    
    response = await call_next(request)
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞—Ä—É—à–µ–Ω–∏–µ –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ 429
    if response.status_code == 429 and user_id:
        record_rate_limit_violation(user_id)
    
    return response
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

---

#### 10. Secrets –≤ environment variables –±–µ–∑ rotation
**–û–ø–∏—Å–∞–Ω–∏–µ:** –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ .env —Ñ–∞–π–ª–µ –±–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Ä–æ—Ç–∞—Ü–∏–∏, —á—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∏—Å–∫ –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏.

**–§–∞–π–ª—ã:** `.env`, `config.py`

**–†–∏—Å–∫:**
- –î–ª–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ–π —Ä–æ—Ç–∞—Ü–∏–∏
- –ù–∞—Ä—É—à–µ–Ω–∏–µ best practices –¥–ª—è production

**–†–µ—à–µ–Ω–∏–µ:**
```python
# 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker Secrets –¥–ª—è production
# docker-compose.yml –¥–ª—è production:
version: '3.8'
services:
  api:
    secrets:
      - jwt_secret
      - google_api_key
      - telegram_bot_token
      - postgres_password
    environment:
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - GOOGLE_API_KEY_FILE=/run/secrets/google_api_key
      - TELEGRAM_BOT_TOKEN_FILE=/run/secrets/telegram_bot_token
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password

secrets:
  jwt_secret:
    external: true
  google_api_key:
    external: true
  telegram_bot_token:
    external: true
  postgres_password:
    external: true

# 2. –û–±–Ω–æ–≤–∏—Ç—å config.py –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ñ–∞–π–ª–æ–≤
import os

def get_secret(name: str, default: str = None) -> str:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç –∏–∑ —Ñ–∞–π–ª–∞ (_FILE suffix) –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è.
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ñ–∞–π–ª > env variable > default
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª
    file_path = os.getenv(f"{name}_FILE")
    if file_path and os.path.exists(file_path):
        with open(file_path, 'r') as f:
            return f.read().strip()
    
    # Fallback –Ω–∞ env variable
    value = os.getenv(name)
    if value:
        return value
    
    if default is None:
        raise ValueError(f"{name} –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ {name} –∏–ª–∏ {name}_FILE")
    
    return default

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
JWT_SECRET = get_secret("JWT_SECRET")
GOOGLE_API_KEY = get_secret("GOOGLE_API_KEY")
TELEGRAM_BOT_TOKEN = get_secret("TELEGRAM_BOT_TOKEN")
POSTGRES_PASSWORD = get_secret("POSTGRES_PASSWORD")

# 3. –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤ (scripts/rotate_secrets.sh)
#!/bin/bash
# –†–æ—Ç–∞—Ü–∏—è JWT_SECRET

set -e

echo "Generating new JWT secret..."
NEW_SECRET=$(openssl rand -hex 32)

echo "Creating Docker secret..."
echo "$NEW_SECRET" | docker secret create jwt_secret_v2 -

echo "Updating service..."
docker service update --secret-rm jwt_secret --secret-add source=jwt_secret_v2,target=jwt_secret evolveai_api

echo "Waiting for service to restart..."
sleep 10

echo "Removing old secret..."
docker secret rm jwt_secret_v1

echo "Secret rotation complete!"

# 4. –î–ª—è AWS –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AWS Secrets Manager
# pip install boto3

import boto3
from botocore.exceptions import ClientError

def get_aws_secret(secret_name: str, region: str = "us-east-1") -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç –∏–∑ AWS Secrets Manager."""
    client = boto3.client('secretsmanager', region_name=region)
    
    try:
        response = client.get_secret_value(SecretId=secret_name)
        return response['SecretString']
    except ClientError as e:
        logging.error(f"Failed to retrieve secret {secret_name}: {e}")
        raise

# –í config.py –¥–ª—è production:
if os.getenv('ENVIRONMENT') == 'production':
    JWT_SECRET = get_aws_secret("evolveai/jwt_secret")
else:
    JWT_SECRET = get_secret("JWT_SECRET")
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í—ã—Å–æ–∫–∏–π (–¥–ª—è production)  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 4-6 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è-–í—ã—Å–æ–∫–∞—è

---

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (CVSS 4.0-6.9) üü°

#### 11. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Content Security Policy (CSP) headers
**–û–ø–∏—Å–∞–Ω–∏–µ:** API –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç security headers (CSP, X-Frame-Options, etc.), —á—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç —Ä–∏—Å–∫ XSS –∞—Ç–∞–∫.

**–§–∞–π–ª—ã:** `main.py`

**–†–µ—à–µ–Ω–∏–µ:**
```python
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from starlette.middleware.base import BaseHTTPMiddleware

class SecurityHeadersMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        response = await call_next(request)
        
        # Security headers
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "DENY"
        response.headers["X-XSS-Protection"] = "1; mode=block"
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
        response.headers["Permissions-Policy"] = "geolocation=(), microphone=(), camera=()"
        
        # CSP –¥–ª—è API (—Å—Ç—Ä–æ–≥–∏–π)
        response.headers["Content-Security-Policy"] = "default-src 'none'; frame-ancestors 'none'"
        
        return response

app.add_middleware(SecurityHeadersMiddleware)
app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=["your-domain.com", "*.your-domain.com"]
)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 30 –º–∏–Ω—É—Ç  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

---

#### 12. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ, —á—Ç–æ –∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞—Ç–∞–∫.

**–§–∞–π–ª—ã:** `main.py:146-162`

**–†–µ—à–µ–Ω–∏–µ:**
```python
async def verify_token(credentials: HTTPAuthorizationCredentials = Depends(security)) -> dict:
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="Could not validate credentials",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        payload = jwt.decode(credentials.credentials, SECRET_KEY, algorithms=[ALGORITHM])
        sub = payload.get("sub")
        if sub is None:
            raise credentials_exception
        user_id: int = int(sub)
        if user_id is None:
            raise credentials_exception
    except jwt.ExpiredSignatureError:
        # SECURITY LOG: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        logging.warning(f"Expired JWT token from IP: {get_remote_address(request)}")
        raise credentials_exception
    except jwt.InvalidTokenError as e:
        logging.warning(f"Invalid JWT token from IP: {get_remote_address(request)}, error: {str(e)}")
        raise credentials_exception
    except JWTError as je:
        logging.error(f"JWT Error: {str(je)}, IP: {get_remote_address(request)}")
        raise credentials_exception
    return user_id
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 1 —á–∞—Å  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

---

#### 13. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ timeout –Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ AI
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI –æ—Ç–≤–µ—Ç–æ–≤ –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –±–µ–∑ timeout, –±–ª–æ–∫–∏—Ä—É—è —Ä–µ—Å—É—Ä—Å—ã.

**–§–∞–π–ª—ã:** `server/ai.py`

**–†–µ—à–µ–Ω–∏–µ:**
```python
import asyncio

async def generate_ai_response(...):
    try:
        # Timeout –Ω–∞ –≤—Å—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (–º–∞–∫—Å 3 –º–∏–Ω—É—Ç—ã)
        return await asyncio.wait_for(
            _generate_ai_response_internal(...),
            timeout=180.0
        )
    except asyncio.TimeoutError:
        logging.error(f"AI generation timeout for user {user_id}")
        return {
            "text": "–ò–∑–≤–∏–Ω–∏, –º–Ω–µ –Ω—É–∂–Ω–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å.",
            "image_base64": None
        }
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 1 —á–∞—Å  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

---

#### 14. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ input validation –Ω–∞ webhook endpoints
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ï—Å–ª–∏ –¥–æ–±–∞–≤—è—Ç—Å—è webhook endpoints, –Ω—É–∂–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏.

**–†–µ—à–µ–Ω–∏–µ:**
```python
import hmac
import hashlib

def verify_telegram_webhook(request: Request, secret: str) -> bool:
    """–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç Telegram webhook signature."""
    signature = request.headers.get("X-Telegram-Bot-Api-Secret-Token")
    if not signature:
        return False
    return hmac.compare_digest(signature, secret)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π (–µ—Å–ª–∏ webhooks –¥–æ–±–∞–≤—è—Ç—Å—è)  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 1 —á–∞—Å  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

---

#### 15. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ù–µ—Ç —Å–∏—Å—Ç–µ–º—ã –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π (–≤–Ω–µ–∑–∞–ø–Ω—ã–π –≤—Å–ø–ª–µ—Å–∫ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–∞—Ç—Ç–µ—Ä–Ω—ã –±–æ—Ç–∞).

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Prometheus + Grafana + alerts
# Metrics —É–∂–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ starlette-prometheus

# –î–æ–±–∞–≤–∏—Ç—å custom metrics –¥–ª—è –∞–Ω–æ–º–∞–ª–∏–π
from prometheus_client import Counter, Histogram

ANOMALY_DETECTED = Counter('security_anomalies_total', 'Detected security anomalies', ['type'])

async def detect_anomalies(user_id: int, request_count: int, time_window: int):
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∞–Ω–æ–º–∞–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å."""
    # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –±–æ–ª—å—à–µ 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
    if request_count > 100:
        ANOMALY_DETECTED.labels(type='high_request_rate').inc()
        logging.warning(f"Anomaly detected: user {user_id} made {request_count} requests in {time_window}s")
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 4-6 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è

---

## üìä –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (GDPR Compliance)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### –ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è:
1. **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:** Telegram user_id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
2. **–ü—Ä–æ—Ñ–∏–ª—å:** –∏–º—è, –ø–æ–ª, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, –≥–æ—Ä–æ–¥
3. **–ö–æ–Ω—Ç–µ–Ω—Ç:** –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π, –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
4. **–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ:** —É—Ä–æ–≤–µ–Ω—å –æ—Ç–Ω–æ—à–µ–Ω–∏–π, –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å, –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
5. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ:** IP –∞–¥—Ä–µ—Å–∞ (–≤ –ª–æ–≥–∞—Ö), User-Agent

#### GDPR —Å—Ç–∞—Ç—É—Å:

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:**
- –Ø–≤–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/start`
- –ü—Ä–∞–≤–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `/delete_my_data`
- –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ)
- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (README –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)

‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è:**
- –ù–µ—Ç Privacy Policy –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è at-rest
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å PII (—Å–º. –ø—É–Ω–∫—Ç 3)
- –ù–µ—Ç Data Processing Agreement –¥–ª—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (Google AI)

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–°–æ–∑–¥–∞—Ç—å Privacy Policy (PRIVACY.md)**
```markdown
# –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ EvolveAI

## 1. –ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –º—ã —Å–æ–±–∏—Ä–∞–µ–º
- Telegram user_id (–¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
- –ò–º—è, –ø–æ–ª, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏)
- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–±—â–µ–Ω–∏—è)
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)

## 2. –ö–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—â–µ–Ω–∏—è
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–∞–Ω–æ–Ω–∏–º–Ω–æ)

## 3. –ö–∞–∫ –¥–æ–ª–≥–æ –º—ã —Ö—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ
- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: –¥–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –ü—Ä–æ—Ñ–∏–ª—å: –¥–æ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
- –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏: 30 –¥–Ω–µ–π

## 4. –í–∞—à–∏ –ø—Ä–∞–≤–∞
- –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö: `/profile`
- –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: `/delete_my_data`
- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö: [–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è]

## 5. –¢—Ä–µ—Ç—å–∏ —Å—Ç–æ—Ä–æ–Ω—ã
- Google AI (Gemini) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- Telegram - –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–æ—Å—Ç–∞–≤–∫–∏

## 6. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (TLS)
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è [–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ]
- –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∞—É–¥–∏—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## 7. –ö–æ–Ω—Ç–∞–∫—Ç—ã
support@evolveai.example
```

2. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö**
```python
@router.message(Command("export_my_data"))
async def export_user_data(message: types.Message, client: httpx.AsyncClient):
    """–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (GDPR Article 20)."""
    user_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    profile = await get_profile(user_id)
    history = await get_unsummarized_messages(user_id)
    memories = await get_all_long_term_memories(user_id)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º JSON
    export_data = {
        "exported_at": datetime.now(timezone.utc).isoformat(),
        "user_id": user_id,
        "profile": profile.to_dict() if profile else None,
        "chat_history": [msg.to_dict() for msg in history],
        "long_term_memory": [mem.to_dict() for mem in memories],
    }
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ñ–∞–π–ª
    import json
    file_content = json.dumps(export_data, indent=2, ensure_ascii=False)
    await message.answer_document(
        BufferedInputFile(
            file_content.encode('utf-8'),
            filename=f"evolveai_data_export_{user_id}.json"
        ),
        caption="üì¶ –≠–∫—Å–ø–æ—Ä—Ç –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (GDPR)"
    )
```

3. **Data Retention Policy**
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ 2 –≥–æ–¥–∞
async def cleanup_inactive_accounts():
    """–£–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–ª–µ–µ 2 –ª–µ—Ç."""
    threshold_date = datetime.now(timezone.utc) - timedelta(days=730)
    
    async with async_session_factory() as session:
        # –ù–∞—Ö–æ–¥–∏–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        result = await session.execute(
            select(UserProfile).where(
                UserProfile.last_message_date < threshold_date
            )
        )
        inactive_users = result.scalars().all()
        
        for user in inactive_users:
            logging.info(f"Deleting inactive user {user.user_id} (last active: {user.last_message_date})")
            await delete_profile(user.user_id)
            await delete_chat_history(user.user_id)
            await delete_long_term_memory(user.user_id)
```

---

## üîê –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

### Production Checklist:

#### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:
- [ ] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π JWT_SECRET (openssl rand -hex 32)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å HTTPS —á–µ—Ä–µ–∑ nginx + Let's Encrypt
- [ ] –í–∫–ª—é—á–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ë–î (pg_crypto –∏–ª–∏ application-level)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Secrets –≤–º–µ—Å—Ç–æ .env
- [ ] –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ë–î (—Ç–æ–ª—å–∫–æ –∏–∑ Docker —Å–µ—Ç–∏)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å firewall (ufw/iptables)
- [ ] –í–∫–ª—é—á–∏—Ç—å fail2ban –¥–ª—è SSH
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã (scripts/backup_database.sh –≤ cron)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Grafana + Prometheus + AlertManager)
- [ ] –î–æ–±–∞–≤–∏—Ç—å WAF (ModSecurity –∏–ª–∏ Cloudflare)

#### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ penetration testing
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å centralized logging (ELK stack)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å alerting –Ω–∞ –∞–Ω–æ–º–∞–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å incident response plan
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ GDPR compliance audit
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å rate limiting –Ω–∞ nginx level
- [ ] –í–∫–ª—é—á–∏—Ç—å DDoS protection (Cloudflare)

---

## üìà –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### Roadmap –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

#### –§–∞–∑–∞ 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è) - 1-2 –Ω–µ–¥–µ–ª–∏:
1. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î (–ø—É–Ω–∫—Ç 1)
2. –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–ø—É–Ω–∫—Ç 2)
3. –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ PII –≤ –ª–æ–≥–∞—Ö (–ø—É–Ω–∫—Ç 3)
4. HTTPS –¥–ª—è API (–ø—É–Ω–∫—Ç 4)

#### –§–∞–∑–∞ 2 (–í—ã—Å–æ–∫–∞—è) - 2-3 –Ω–µ–¥–µ–ª–∏:
5. –í–∞–ª–∏–¥–∞—Ü–∏—è image_data (–ø—É–Ω–∫—Ç 5)
6. –£—Å–∏–ª–µ–Ω–∏–µ JWT_SECRET (–ø—É–Ω–∫—Ç 6)
7. CSRF –∑–∞—â–∏—Ç–∞ (–ø—É–Ω–∫—Ç 7)
8. –ê—É–¥–∏—Ç premium —Ñ—É–Ω–∫—Ü–∏–π (–ø—É–Ω–∫—Ç 8)
9. Rate limit bypass –∑–∞—â–∏—Ç–∞ (–ø—É–Ω–∫—Ç 9)
10. Secrets rotation (–ø—É–Ω–∫—Ç 10)

#### –§–∞–∑–∞ 3 (–°—Ä–µ–¥–Ω—è—è) - 1 –º–µ—Å—è—Ü:
11. Security headers (–ø—É–Ω–∫—Ç 11)
12. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ auth failures (–ø—É–Ω–∫—Ç 12)
13. Timeout –Ω–∞ AI –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø—É–Ω–∫—Ç 13)
14. Webhook validation (–ø—É–Ω–∫—Ç 14)
15. Anomaly detection (–ø—É–Ω–∫—Ç 15)

#### –§–∞–∑–∞ 4 (GDPR) - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:
- Privacy Policy –¥–æ–∫—É–º–µ–Ω—Ç
- –ö–æ–º–∞–Ω–¥–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
- Data retention policy
- DPA —Å Google AI

---

## üõ°Ô∏è –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç **—Ö–æ—Ä–æ—à–∏–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç** –≤ –æ–±–ª–∞—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- ‚úÖ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É–∂–µ –≤–Ω–µ–¥—Ä–µ–Ω–∞
- ‚úÖ Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ SQL Injection –∑–∞—â–∏—â–µ–Ω
- ‚úÖ Circuit Breaker –¥–ª—è Redis
- ‚úÖ Docker –∏–∑–æ–ª—è—Ü–∏—è

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ** —É–ª—É—á—à–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç—Å—è –≤:
1. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö at-rest
2. –ó–∞—â–∏—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
3. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
4. HTTPS –¥–ª—è production

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏ –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç **–≥–æ—Ç–æ–≤ –∫ production deployment** —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

**–û—Ü–µ–Ω–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞:** 7/10 üü¢  
**–û—Ü–µ–Ω–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 9.5/10 ‚≠ê

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** AI Security Auditor  
**–î–∞—Ç–∞:** 2025-01-07  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
