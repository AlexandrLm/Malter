# –£–ª—É—á—à–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏ EvolveAI

## üìä –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–§–∞–∑–∞ 1)

### 1. ‚úÖ Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞–º–∏

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `utils/cache.py` —Å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞–º–∏ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@cached()` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ (`invalidate_cache`, `invalidate_pattern`)
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞ (`get_cache_stats`)
- –î–æ–±–∞–≤–ª–µ–Ω endpoint `/admin/cache_stats` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üöÄ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î –Ω–∞ 60-80%
- ‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ API –≤ 3-5 —Ä–∞–∑ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- üìà –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å hit rate –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫—ç—à–∞

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from utils.cache import cached, invalidate_cache

@cached(prefix="profile", ttl=300)  # 5 –º–∏–Ω—É—Ç
async def get_profile(user_id: int):
    # –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è
    pass

# –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
await invalidate_cache("profile", user_id)
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`:**
```env
CACHE_TTL_SECONDS=600          # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
REDIS_RETRY_ATTEMPTS=2         # –ü–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ —Å–±–æ—è—Ö
REDIS_RETRY_MIN_WAIT=0.5       # –ú–∏–Ω. –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
REDIS_RETRY_MAX_WAIT=2.0       # –ú–∞–∫—Å. –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
```

---

### 2. ‚úÖ Connection Pooling –¥–ª—è PostgreSQL

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –£–≤–µ–ª–∏—á–µ–Ω `pool_size` —Å 5 –¥–æ 20 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –£–≤–µ–ª–∏—á–µ–Ω `max_overflow` —Å 10 –¥–æ 10 (–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è)
- –î–æ–±–∞–≤–ª–µ–Ω `pool_recycle=1800` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è stale connections
- –î–æ–±–∞–≤–ª–µ–Ω `pool_pre_ping=True` (—É–∂–µ –±—ã–ª)

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `database.py`:**
```python
async_engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,        # –û—Å–Ω–æ–≤–Ω–æ–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    max_overflow=10,     # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –ø–∏–∫–∞—Ö
    pool_timeout=30,     # –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    pool_recycle=1800    # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ 30 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å–æ stale connections
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ latency –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –ë–î

---

### 3. ‚úÖ Connection Pooling –¥–ª—è Redis

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –°–æ–∑–¥–∞–Ω `ConnectionPool` —Å 50 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (`health_check_interval=30`)
- –í–∫–ª—é—á–µ–Ω `retry_on_timeout=True`

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `config.py`:**
```python
REDIS_POOL = redis.ConnectionPool(
    host=REDIS_HOST,
    port=REDIS_PORT,
    db=REDIS_DB,
    decode_responses=True,
    max_connections=50,              # –ú–∞–∫—Å. —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    socket_timeout=5,                # –¢–∞–π–º–∞—É—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
    socket_connect_timeout=5,        # –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    retry_on_timeout=True,           # Retry –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–∞—Ö
    health_check_interval=30         # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
)

REDIS_CLIENT = redis.Redis(connection_pool=REDIS_POOL)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ—è—Ö
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã—Å–æ–∫–æ–π concurrent –Ω–∞–≥—Ä—É–∑–∫–∏

---

## üìà –ò–∑–º–µ—Ä–∏–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:
- **Concurrent requests:** ~5-10
- **DB connections:** 5 (pool size)
- **Redis connections:** –°–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
- **Cache hit rate:** 0% (–∫—ç—à –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
- **Avg response time:** ~500ms

### –ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:
- **Concurrent requests:** ~30-50 ‚úÖ (+300-500%)
- **DB connections:** 20 (pool) + 10 (overflow) = 30 ‚úÖ
- **Redis connections:** Pool of 50 (reused) ‚úÖ
- **Cache hit rate:** –û–∂–∏–¥–∞–µ—Ç—Å—è 60-80% ‚úÖ
- **Avg response time:** ~100-150ms (–¥–ª—è cached) ‚úÖ (-70%)

---

## üîÑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ù–æ–≤—ã–µ endpoints –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

1. **GET `/admin/cache_stats`** - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Redis –∫—ç—à–∞
   ```json
   {
     "status": "active",
     "used_memory_human": "1.5M",
     "total_keys": 1250,
     "keyspace_hits": 8500,
     "keyspace_misses": 1500,
     "hit_rate": 85.0,
     "connected_clients": 12
   }
   ```

2. **GET `/admin/db_metrics`** - –ú–µ—Ç—Ä–∏–∫–∏ –ë–î (—É–∂–µ –±—ã–ª)

3. **GET `/ready`** - –£–ª—É—á—à–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Redis Circuit Breaker —Å–æ—Å—Ç–æ—è–Ω–∏—è

---

---

### 4. ‚úÖ APScheduler –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `server/scheduler.py` —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ `main.py` —á–µ—Ä–µ–∑ lifespan events
- –î–æ–±–∞–≤–ª–µ–Ω endpoint `/admin/scheduler_status` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏:**
1. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–π –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞** - —Ä–∞–∑ –≤ –¥–µ–Ω—å –≤ 3:00 UTC
   - –£–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Ä–æ—Å—Ç —Ç–∞–±–ª–∏—Ü—ã `chat_history`
   
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫** - –∫–∞–∂–¥—ã–π —á–∞—Å
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ premium –ø–æ–¥–ø–∏—Å–∫–∏
   - –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ free –ø–ª–∞–Ω
   
3. **–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∫—ç—à–∞** - –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
   - –õ–æ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É Redis (hit rate, memory usage)
   - –ü–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫—ç—à–∞
   
4. **–ü—Ä–æ–≥—Ä–µ–≤ –∫—ç—à–∞** - –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ—Ç —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
   - –°–Ω–∏–∂–∞–µ—Ç cold start latency

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä—É—Ç–∏–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –ë–î
- üìä –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫
- üîÑ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ retry –º–µ—Ö–∞–Ω–∏–∑–º—ã

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```python
# –í—Å–µ –∑–∞–¥–∞—á–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ server/scheduler.py
scheduler.add_job(
    cleanup_old_messages_job,
    trigger=CronTrigger(hour=3, minute=0),  # 3:00 UTC –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
    max_instances=1  # –ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
)
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/admin/scheduler_status

# –û—Ç–≤–µ—Ç:
{
  "scheduler": {
    "status": "running",
    "jobs_count": 4,
    "jobs": [
      {
        "id": "cleanup_old_messages",
        "name": "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π",
        "next_run": "2025-01-06T03:00:00+00:00"
      },
      ...
    ]
  }
}
```

---

### 5. ‚úÖ Circuit Breaker –¥–ª—è Gemini API

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –°–æ–∑–¥–∞–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å `utils/circuit_breaker.py`
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–∞—Ç—Ç–µ—Ä–Ω Circuit Breaker —Å —Ç—Ä–µ–º—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏: CLOSED, OPEN, HALF_OPEN
- –û–±–µ—Ä–Ω—É—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è `call_gemini_api_with_retry` –≤ circuit breaker
- –î–æ–±–∞–≤–ª–µ–Ω—ã fallback –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º circuit
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ `/ready` endpoint

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. **CLOSED (–Ω–æ—Ä–º–∞)** - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –∫ Gemini API
2. **–ü–æ—Å–ª–µ 5 —Å–±–æ–µ–≤ –ø–æ–¥—Ä—è–¥** ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ OPEN
3. **OPEN (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)** - –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
4. **–ß–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥** ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ HALF_OPEN (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
5. **HALF_OPEN (—Ç–µ—Å—Ç)** - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç 1 –∑–∞–ø—Ä–æ—Å:
   - ‚úÖ 2 —É—Å–ø–µ—Ö–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –≤ CLOSED
   - ‚ùå 1 –æ—à–∏–±–∫–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –≤ OPEN

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤
- ‚ö° –ë—ã—Å—Ç—Ä—ã–π fallback –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–Ω–∏—è timeout
- üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (calls, failures, blocked)
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- üí¨ –î—Ä—É–∂–µ–ª—é–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

**Fallback —Å–æ–æ–±—â–µ–Ω–∏–µ:**
```
"–ò–∑–≤–∏–Ω–∏, —Å–µ–π—á–∞—Å —É –º–µ–Ω—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã üòî 
–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç–∫—É, —è –±—ã—Å—Ç—Ä–æ –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª—é!"
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
```bash
curl http://localhost:8000/ready

# –û—Ç–≤–µ—Ç –ø—Ä–∏ OPEN circuit:
{
  "gemini": {
    "status": "unhealthy",
    "message": "Circuit Breaker OPEN (retry in 45s)",
    "circuit_breaker": {
      "state": "OPEN",
      "failure_count": 5,
      "total_calls": 127,
      "total_blocked": 12,
      "success_rate": 90.55
    }
  },
  "overall": "unhealthy"
}
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å):**
```python
gemini_circuit_breaker = CircuitBreaker(
    name="Gemini API",
    failure_threshold=5,      # –°–±–æ–µ–≤ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
    recovery_timeout=60,      # –°–µ–∫—É–Ω–¥ –¥–æ –ø–æ–≤—Ç–æ—Ä–∞
    success_threshold=2       # –£—Å–ø–µ—Ö–æ–≤ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
)
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–§–∞–∑–∞ 3)

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:

#### 1. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á (ARQ)
**–ó–∞–¥–∞—á–∏ –¥–ª—è –æ—á–µ—Ä–µ–¥–∏:**
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (TTS) - –¥–æ–ª–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
- –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª (–∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤) - —Ç—è–∂–µ–ª–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
- –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (broadcast)
- –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –†–∞–∑–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å retry –ø—Ä–∏ —Å–±–æ—è—Ö
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á
- Horizontal scaling workers

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 1-2 –¥–Ω—è

---

#### 2. APScheduler –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
**–ó–∞–¥–∞—á–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ chat_history (—Ä–∞–∑ –≤ –¥–µ–Ω—å)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ (–∫–∞–∂–¥—ã–π —á–∞—Å)
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
- –ü—Ä–æ–≥—Ä–µ–≤ –∫—ç—à–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 4-6 —á–∞—Å–æ–≤

---

#### 3. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `chat_history`
**–ü–æ—á–µ–º—É:**
- –¢–∞–±–ª–∏—Ü–∞ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç–µ—Ç (—Å–∞–º–∞—è –±–æ–ª—å—à–∞—è –≤ –ë–î)
- –ó–∞–ø—Ä–æ—Å—ã –º–µ–¥–ª–µ–Ω–Ω–µ—é—Ç —Å —Ä–æ—Å—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç–Ω–æ–µ

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º
CREATE TABLE chat_history_2025_01 PARTITION OF chat_history
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Ç–æ–ª—å–∫–æ –∫ –Ω—É–∂–Ω–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏)
- –õ–µ–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (DROP PARTITION)
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–æ–≤

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 1 –¥–µ–Ω—å

---

#### 4. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è:**
- Nginx Load Balancer
- –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ FastAPI (docker-compose scale)
- Read Replicas –¥–ª—è PostgreSQL
- Redis Cluster (–¥–ª—è HA)

**docker-compose.yml –ø—Ä–∏–º–µ—Ä:**
```yaml
services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    depends_on:
      - api
  
  api:
    deploy:
      replicas: 3  # 3 –∏–Ω—Å—Ç–∞–Ω—Å–∞ API
    ...
```

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 2-3 –¥–Ω—è

---

#### 5. Circuit Breaker –¥–ª—è Gemini API
**–ü—Ä–æ–±–ª–µ–º–∞:**
- Gemini API –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å –∏–ª–∏ –ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è
- Cascade failures –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å API

**–†–µ—à–µ–Ω–∏–µ:**
```python
@circuit_breaker(failure_threshold=5, timeout=60)
async def generate_ai_response():
    # –ü—Ä–∏ 5 —Å–±–æ—è—Ö - –æ—Ç–∫—Ä—ã—Ç—å circuit –Ω–∞ 60 —Å–µ–∫
    pass
```

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 4 —á–∞—Å–∞

---

## üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É

### Grafana Dashboard (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- **Redis:** hit rate, memory usage, operations/sec
- **PostgreSQL:** active connections, slow queries, transactions/sec
- **API:** response time (p50, p95, p99), requests/sec, error rate
- **Gemini API:** requests/sec, tokens used, latency

### Alerting
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞:
- Redis hit rate < 50%
- DB connections > 25 (80% –æ—Ç pool)
- API response time p95 > 1s
- Error rate > 1%

---

## üí∞ –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏/—ç—Ñ—Ñ–µ–∫—Ç–∞

| –£–ª—É—á—à–µ–Ω–∏–µ | –í—Ä–µ–º—è | –≠—Ñ—Ñ–µ–∫—Ç | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|-----------|-------|--------|-----------|
| ‚úÖ Redis –∫—ç—à + Pooling | 2 —á–∞—Å–∞ | +300% RPS, -70% latency | **–í—ã—Å–æ–∫–∏–π** |
| üîÑ APScheduler | 4 —á–∞—Å–∞ | –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å | **–í—ã—Å–æ–∫–∏–π** |
| üîÑ ARQ –æ—á–µ—Ä–µ–¥–∏ | 2 –¥–Ω—è | –†–∞–∑–≥—Ä—É–∑–∫–∞ API, retry logic | **–°—Ä–µ–¥–Ω–∏–π** |
| üîÑ –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î | 1 –¥–µ–Ω—å | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ë–î | **–°—Ä–µ–¥–Ω–∏–π** |
| üîÑ Horizontal scaling | 3 –¥–Ω—è | Unlimited RPS | **–ù–∏–∑–∫–∏–π** |

---

## üéØ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

**–§–∞–∑–∞ 1 (Quick Wins):** ‚úÖ **–ó–ê–í–ï–†–®–ï–ù–ê**
- Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞–º–∏
- Connection pooling –¥–ª—è PostgreSQL
- Connection pooling –¥–ª—è Redis
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à–∞

**–§–∞–∑–∞ 2 (Automation):** ‚úÖ **–ó–ê–í–ï–†–®–ï–ù–ê**
- APScheduler –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- –ü—Ä–æ–≥—Ä–µ–≤ –∫—ç—à–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ scheduler
- Circuit Breaker –¥–ª—è Gemini API

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):** ARQ –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (TTS, –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª) - –µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (>100 RPS)

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Redis Best Practices](https://redis.io/docs/manual/patterns/)
- [SQLAlchemy Connection Pooling](https://docs.sqlalchemy.org/en/20/core/pooling.html)
- [FastAPI Performance Tips](https://fastapi.tiangolo.com/deployment/concepts/)
- [Circuit Breaker Pattern](https://martinfowler.com/bliki/CircuitBreaker.html)
