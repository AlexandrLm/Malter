# EvolveAI Companion - Документация API

## Общая информация

Это API-документация для бэкенд-сервиса **EvolveAI Companion**. API предоставляет интерфейс для управления профилями пользователей, ведения диалогов с ИИ и получения служебной информации.

**Базовый URL:** `http://127.0.0.1:8000` (для локальной разработки) или `http://api:8000` (внутри Docker-сети).

**Формат данных:** Все запросы и ответы используют формат `application/json`.

**Обработка ошибок:**
*   **Ошибки валидации (422 Unprocessable Entity):** Возникают, если тело запроса не соответствует Pydantic-схеме. Ответ будет содержать подробную информацию о полях с ошибками.
*   **Ошибки сервера (5xx):** В случае внутренних ошибок сервер вернет ответ с кодом 500 или 503.
```json
{
  "detail": "Сообщение об ошибке"
}
```

---

## 1. Основное взаимодействие

### 1.1. Отправить сообщение в чат

Основной эндпоинт для взаимодействия с ИИ. Принимает текстовое сообщение и, опционально, изображение. Возвращает текстовый и/или голосовой ответ.

*   **Метод:** `POST`
*   **Путь:** `/chat`
*   **Ограничение частоты:** 10 запросов в минуту на `user_id`.

**Тело запроса (`ChatRequest`):**

```json
{
  "user_id": 123456789,
  "message": "Привет! Как прошел твой день?",
  "timestamp": "2023-10-27T10:00:00Z",
  "image_data": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQ..."
}
```

| Поле         | Тип      | Описание                                                                                             | Обязательно |
|--------------|----------|------------------------------------------------------------------------------------------------------|-------------|
| `user_id`    | `integer`| Уникальный идентификатор пользователя в Telegram.                                                    | Да          |
| `message`    | `string` | Текстовое сообщение пользователя. Может быть пустым, если отправлено только изображение.             | Да          |
| `timestamp`  | `string` | Время отправки сообщения в формате ISO 8601.                                                         | Да          |
| `image_data` | `string` | Изображение, закодированное в Base64. `null`, если изображение не отправлено.                       | Нет         |

**Успешный ответ (200 OK) (`ChatResponse`):**

```json
{
  "response_text": "Privet! || Все отлично, спасибо, что спросил!",
  "voice_message": "base64_encoded_ogg_voice_data..."
}
```

| Поле            | Тип      | Описание                                                                                             |
|-----------------|----------|------------------------------------------------------------------------------------------------------|
| `response_text` | `string` | Сгенерированный текстовый ответ ИИ. Части могут быть разделены `||` для поэтапной отправки.        |
| `voice_message` | `bytes`  | Голосовое сообщение в формате OGG, закодированное в Base64. `null`, если голосовое не сгенерировано. |

---

## 2. Управление профилем

Эндпоинты для создания, получения, обновления и удаления профиля пользователя.

### 2.1. Получить профиль пользователя

*   **Метод:** `GET`
*   **Путь:** `/profile/{user_id}`

**Параметры пути:**

| Параметр  | Тип       | Описание                                   |
|-----------|-----------|--------------------------------------------|
| `user_id` | `integer` | Уникальный идентификатор пользователя.     |

**Успешный ответ (200 OK) (`ProfileData`):**
Если профиль найден:
```json
{
  "name": "Александр",
  "gender": "мальчик",
  "timezone": "Europe/Moscow"
}
```

Если профиль не найден, вернется `null` с кодом 200.
```json
null
```

### 2.2. Создать или обновить профиль

Атомарно создает новый профиль или обновляет существующий (UPSERT).

*   **Метод:** `POST`
*   **Путь:** `/profile`

**Тело запроса (`ProfileUpdate`):**

```json
{
  "user_id": 123456789,
  "data": {
    "name": "Александр",
    "gender": "мальчик",
    "timezone": "Europe/Moscow"
  }
}
```

**Успешный ответ (200 OK):**
```json
{
  "message": "Профиль успешно обновлен"
}
```

### 2.3. Удалить профиль пользователя

Полностью удаляет профиль пользователя и всю связанную с ним информацию (историю чата, долгосрочную память, сводки).

*   **Метод:** `DELETE`
*   **Путь:** `/profile/{user_id}`

**Параметры пути:**

| Параметр  | Тип       | Описание                                   |
|-----------|-----------|--------------------------------------------|
| `user_id` | `integer` | Уникальный идентификатор пользователя.     |

**Успешный ответ (200 OK):**
```json
{
  "message": "Профиль и история чата успешно удалены"
}
```

### 2.4. Получить статус профиля

Возвращает информацию о статусе подписки и количестве сообщений за день.

*   **Метод:** `GET`
*   **Путь:** `/profile/status/{user_id}`

**Параметры пути:**

| Параметр  | Тип       | Описание                                   |
|-----------|-----------|--------------------------------------------|
| `user_id` | `integer` | Уникальный идентификатор пользователя.     |

**Успешный ответ (200 OK) (`ProfileStatus`):**
```json
{
  "subscription_plan": "free",
  "subscription_expires": null,
  "daily_message_count": 25
}
```

**Ответ при ошибке (404 Not Found):**
Если профиль пользователя не найден.
```json
{
  "detail": "Профиль не найден"
}
```

---

## 3. История чата

### 3.1. Получить историю чата

Возвращает все сообщения из истории, которые еще не были включены в сводку (summarized).

*   **Метод:** `GET`
*   **Путь:** `/chat_history/{user_id}`

**Параметры пути:**

| Параметр  | Тип       | Описание                                   |
|-----------|-----------|--------------------------------------------|
| `user_id` | `integer` | Уникальный идентификатор пользователя.     |

**Успешный ответ (200 OK) (`ChatHistory`):**
```json
{
  "user_id": 123456789,
  "history": [
    {
      "id": 101,
      "user_id": 123456789,
      "role": "user",
      "content": "Привет!",
      "timestamp": "2023-10-27T10:00:00"
    },
    {
      "id": 102,
      "user_id": 123456789,
      "role": "model",
      "content": "Privet!",
      "timestamp": "2023-10-27T10:00:02"
    }
  ]
}
```
Если история не найдена или пуста, вернется `null` с кодом 200.

---

## 4. Служебные эндпоинты

### 4.1. Корневой эндпоинт

*   **Метод:** `GET`
*   **Путь:** `/`
*   **Ответ:** `{"message": "MashaGPT Backend is running"}`

### 4.2. Проверка работоспособности (Health Check)

*   **Метод:** `GET`
*   **Путь:** `/health`
*   **Ответ (200 OK):** `{"status": "ok"}`

### 4.3. Проверка готовности (Readiness Check)

Проверяет готовность сервиса к приему трафика, включая подключение к базе данных.

*   **Метод:** `GET`
*   **Путь:** `/ready`
*   **Успешный ответ (200 OK):** `{"status": "ready"}`
*   **Ответ при ошибке (503 Service Unavailable):** Если подключение к БД не удалось установить.

### 4.4. Метрики Prometheus

*   **Метод:** `GET`
*   **Путь:** `/metrics`
*   **Ответ:** Текстовый ответ с метриками в формате Prometheus.